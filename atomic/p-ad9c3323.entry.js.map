{"version":3,"names":["buildInteractiveInstantProduct","_engine","_arg","AtomicCommerceSearchBoxInstantProducts","this","products","display","templateHasError","density","imageSize","setRenderFunction","resultRenderingFunction","itemRenderingFunction","componentWillLoad","dispatchSearchBoxSuggestionsEvent","bindings","initialize","host","error","getLink","el","atomicProduct","tagName","querySelector","_a","shadowRoot","handleLinkClick","hasModifier","setTarget","value","setAttribute","initialTarget","getAttribute","click","renderItems","suggestedQuery","store","isMobile","instantProducts","state","length","elements","map","product","partialItem","getPartialInstantItemElement","i18n","ariaLabelGenerator","call","ec_name","permanentid","content","h","key","encodeForDomAttribute","part","interactiveProduct","itemTemplateProvider","getTemplateContent","stopPropagation","renderingFunction","onSelect","e","link","target","ctrlKey","metaKey","getPartialInstantItemShowAllElement","push","InstantItemShowAllButton","clearSuggestions","searchBoxController","updateText","query","submit","buildInstantProducts","engine","options","ProductTemplateProvider","includeDefaultTemplate","templateElements","Array","from","querySelectorAll","getResultTemplateRegistered","setResultTemplateRegistered","getTemplateHasError","setTemplateHasError","position","parentNode","children","indexOf","panel","onSuggestedQueryChange","q","updateQuery","getSuggestionElements","console","warn","Promise","resolve","unsubscribe","subscribe","isLoading","render","element"],"sources":["src/components/commerce/search-box-suggestions/atomic-commerce-search-box-instant-products/atomic-commerce-search-box-instant-products.tsx"],"sourcesContent":["import {\n  SearchBox,\n  buildInstantProducts,\n  Product,\n  InstantProducts,\n  InteractiveProduct,\n  CommerceEngine,\n} from '@coveo/headless/commerce';\nimport {Component, Element, State, h, Prop, Method} from '@stencil/core';\nimport {InitializableComponent} from '../../../../utils/initialization-utils';\nimport {encodeForDomAttribute} from '../../../../utils/string-utils';\nimport {ItemRenderingFunction} from '../../../common/item-list/item-list-common';\nimport {\n  ItemDisplayDensity,\n  ItemDisplayImageSize,\n  ItemDisplayLayout,\n} from '../../../common/layout/display-options';\nimport {\n  getPartialInstantItemElement,\n  getPartialInstantItemShowAllElement,\n  InstantItemShowAllButton,\n} from '../../../common/suggestions/instant-item';\nimport {\n  dispatchSearchBoxSuggestionsEvent,\n  SearchBoxSuggestionElement,\n  SearchBoxSuggestions,\n  SearchBoxSuggestionsBindings,\n} from '../../../common/suggestions/suggestions-common';\nimport {CommerceBindings as Bindings} from '../../atomic-commerce-interface/atomic-commerce-interface';\nimport {ProductTemplateProvider} from '../../product-list/product-template-provider';\n\nexport type AriaLabelGenerator = (\n  bindings: Bindings,\n  product: Product\n) => string | undefined;\n\n// TODO: KIT-3165 Uncomment once the `buildInteractiveInstantProduct` function is implemented in headless.\nfunction buildInteractiveInstantProduct(\n  _engine: CommerceEngine<{}>,\n  _arg: {options: {product: Product}}\n): InteractiveProduct {\n  return {} as InteractiveProduct;\n}\n\n/**\n * The `atomic-commerce-search-box-instant-products` component can be added as a child of an `atomic-search-box` component, allowing for the configuration of instant results behavior.\n *\n * This component does not support accessibility out-of-the-box. To do so, see [Instant Results Accessibility](https://docs.coveo.com/en/atomic/latest/usage/accessibility/#instant-results-accessibility).\n *\n * This component is not supported on mobile.\n *\n * @internal\n */\n@Component({\n  tag: 'atomic-commerce-search-box-instant-products',\n  shadow: true,\n})\nexport class AtomicCommerceSearchBoxInstantProducts\n  implements InitializableComponent<Bindings>\n{\n  public bindings!: SearchBoxSuggestionsBindings<SearchBox, Bindings>;\n  private itemRenderingFunction: ItemRenderingFunction;\n  private products: Product[] = [];\n  private itemTemplateProvider!: ProductTemplateProvider;\n  private instantProducts!: InstantProducts;\n  private display: ItemDisplayLayout = 'list';\n\n  @Element() public host!: HTMLElement;\n\n  @State() public error!: Error;\n  @State() private templateHasError = false;\n\n  /**\n   * Sets a rendering function to bypass the standard HTML template mechanism for rendering results.\n   * You can use this function while working with web frameworks that don't use plain HTML syntax, e.g., React, Angular or Vue.\n   *\n   * Do not use this method if you integrate Atomic in a plain HTML deployment.\n   *\n   * @param resultRenderingFunction\n   */\n  @Method() public async setRenderFunction(\n    resultRenderingFunction: ItemRenderingFunction\n  ) {\n    this.itemRenderingFunction = resultRenderingFunction;\n  }\n  /**\n   * The spacing of various elements in the product list, including the gap between products, the gap between parts of a product, and the font sizes of different parts in a product.\n   */\n  @Prop({reflect: true}) public density: ItemDisplayDensity = 'normal';\n  /**\n   * The expected size of the image displayed in the products.\n   */\n  @Prop({reflect: true}) public imageSize: ItemDisplayImageSize = 'icon';\n  /**\n   * The callback to generate an [`aria-label`](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Attributes/aria-label) for a given product so that accessibility tools can fully describe what's visually rendered by a product.\n   *\n   * By default, or if an empty string is returned, `product.ec_name` is used.\n   */\n  @Prop() public ariaLabelGenerator?: AriaLabelGenerator;\n\n  public componentWillLoad() {\n    try {\n      dispatchSearchBoxSuggestionsEvent<SearchBox, Bindings>((bindings) => {\n        this.bindings = bindings;\n        return this.initialize();\n      }, this.host);\n    } catch (error) {\n      this.error = error as Error;\n    }\n  }\n\n  private getLink(el: HTMLElement): HTMLElement | null {\n    const atomicProduct =\n      el.tagName === 'ATOMIC-PRODUCT'\n        ? el\n        : el?.querySelector('atomic-product');\n\n    return (\n      atomicProduct?.shadowRoot?.querySelector('atomic-product-link a') || null\n    );\n  }\n\n  private handleLinkClick(el: HTMLElement, hasModifier: boolean) {\n    const setTarget = (value: string) => el.setAttribute('target', value);\n    const initialTarget = el.getAttribute('target');\n\n    hasModifier && setTarget('_blank');\n    el.click();\n    hasModifier && setTarget(initialTarget || '');\n\n    return true;\n  }\n\n  private renderItems(): SearchBoxSuggestionElement[] {\n    if (!this.bindings.suggestedQuery() || this.bindings.store.isMobile()) {\n      return [];\n    }\n    const products = this.instantProducts.state.products.length\n      ? this.instantProducts.state.products\n      : this.products;\n\n    const elements: SearchBoxSuggestionElement[] = products.map(\n      (product: Product) => {\n        const partialItem = getPartialInstantItemElement(\n          this.bindings.i18n,\n          this.ariaLabelGenerator?.(this.bindings, product) || product.ec_name!,\n          product.permanentid\n        );\n        return {\n          ...partialItem,\n          content: (\n            <atomic-product\n              key={`instant-product-${encodeForDomAttribute(product.permanentid)}`}\n              part=\"outline\"\n              product={product}\n              interactiveProduct={buildInteractiveInstantProduct(\n                this.bindings.engine,\n                {\n                  options: {product},\n                }\n              )}\n              display={this.display}\n              density={this.density}\n              imageSize={this.imageSize}\n              content={this.itemTemplateProvider.getTemplateContent(product)}\n              stopPropagation={false}\n              renderingFunction={this.itemRenderingFunction}\n            ></atomic-product>\n          ),\n          onSelect: (e: MouseEvent) => {\n            const link = this.getLink(e.target as HTMLElement);\n\n            if (!link) {\n              return;\n            }\n            this.handleLinkClick(link, e.ctrlKey || e.metaKey);\n          },\n        };\n      }\n    );\n    if (elements.length) {\n      const partialItem = getPartialInstantItemShowAllElement(\n        this.bindings.i18n\n      );\n      elements.push({\n        ...partialItem,\n        content: <InstantItemShowAllButton i18n={this.bindings.i18n} />,\n        onSelect: () => {\n          this.bindings.clearSuggestions();\n          this.bindings.searchBoxController.updateText(\n            this.instantProducts.state.query\n          );\n          this.bindings.searchBoxController.submit();\n        },\n      });\n    }\n    return elements;\n  }\n\n  public initialize(): SearchBoxSuggestions {\n    this.instantProducts = buildInstantProducts(this.bindings.engine, {\n      options: {},\n    });\n\n    this.itemTemplateProvider = new ProductTemplateProvider({\n      includeDefaultTemplate: true,\n      templateElements: Array.from(\n        this.host.querySelectorAll('atomic-product-template')\n      ),\n      getResultTemplateRegistered: () => true,\n      setResultTemplateRegistered: () => {},\n      getTemplateHasError: () => this.templateHasError,\n      setTemplateHasError: (value: boolean) => {\n        this.templateHasError = value;\n      },\n    });\n\n    return {\n      position: Array.from(this.host.parentNode!.children).indexOf(this.host),\n      panel: 'right',\n      onSuggestedQueryChange: (q) => {\n        this.instantProducts.updateQuery(q);\n        return this.onSuggestedQueryChange();\n      },\n      renderItems: () => this.renderItems(),\n    };\n  }\n\n  private onSuggestedQueryChange() {\n    if (\n      !this.bindings.getSuggestionElements().length &&\n      !this.bindings.searchBoxController.state.value\n    ) {\n      console.warn(\n        \"There doesn't seem to be any query suggestions configured. Make sure to include either an atomic-commerce-search-box-query-suggestions or atomic-commerce-search-box-recent-queries in your search box in order to see some instant products.\"\n      );\n    }\n\n    return new Promise<void>((resolve) => {\n      const unsubscribe = this.instantProducts.subscribe(() => {\n        const state = this.instantProducts.state;\n        if (!state.isLoading) {\n          if (state.products.length) {\n            this.products = state.products;\n          }\n          unsubscribe();\n          resolve();\n        }\n      });\n    });\n  }\n\n  public render() {\n    if (this.error) {\n      return (\n        <atomic-component-error\n          element={this.host}\n          error={this.error}\n        ></atomic-component-error>\n      );\n    }\n  }\n}\n"],"mappings":"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"}