{"file":"atomic-facet-manager.js","mappings":";;;;;;;;;;;;;;;;;MA4BaA,oBAAkB;;;;;;;;;;;QAoBC,wBAAmB,GAAG,CAAC,CAAC;QAU9C,eAAU,GAAG;YACnB,MAAM,MAAM,GAAG,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAE9C,MAAM,YAAY,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;YAE5E,MAAM,EAAC,aAAa,EAAE,eAAe,EAAC,GAAG,mBAAmB,CAC1D,YAAY,EACZ,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,YAAY,EAAE,CACnC,CAAC;YAEF,MAAM,SAAS,GAAG,0BAA0B,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAExD,mBAAmB,CAAC,aAAa,EAAE,IAAI,CAAC,mBAAmB,CAAC,CAAC;YAE7D,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,+CAA+C,CACxD,IAAI,CAAC,mBAAmB,EACxB,aAAa,CAAC,MAAM,CACrB,CAAC;YAEF,IAAI,CAAC,IAAI,CAAC,MAAM,CACd,GAAG;gBACD,GAAG,aAAa;gBAChB,GAAG,eAAe;gBAClB,IAAI,SAAS,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC;aAClC,CACF,CAAC;SACH,CAAC;;;mCApCkD,CAAC;;IAE9C,UAAU;QACf,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,IAAI,CAAC,YAAY,GAAGC,EAAiB,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;;QAG5D,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;KAC3D;IA8BO,aAAa;QACnB,IAAI,MAAM,CAAC;YACT,kBAAkB,EAAE,IAAI,WAAW,CAAC,EAAC,GAAG,EAAE,CAAC,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAC,CAAC;SAC/D,CAAC,CAAC,QAAQ,CAAC;YACV,kBAAkB,EAAE,IAAI,CAAC,mBAAmB;SAC7C,CAAC,CAAC;KACJ;IAEO,sBAAsB,CAC5B,MAA0B,EAC1B,YAA0B;QAE1B,MAAM,OAAO,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,MAAM;YACjC,OAAO,EAAE,CAAC,CAAC,OAAO;YAClB,OAAO,EAAE,CAAC;SACX,CAAC,CAAC,CAAC;QACJ,OAAO,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,CAAC;KACzD;IAED,oBAAoB;QAClB,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,iBAAiB,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;KAC5D;IAEM,MAAM;QACX,OAAO,8DAAQ,CAAC;KACjB;;;;;;;AAlF4B;IAA5B,kBAAkB,EAAE;sDAA4B;AAS1C;IAJN,qBAAqB,CAAC,cAAc,EAAE;QACrC,sBAAsB,EAAE,YAAY;KACrC,CAAC;+DAE2C;;;;;;;;;;;;;;;;;;;;;;;;;","names":["AtomicFacetManager","buildFacetManager"],"sources":["src/components/search/atomic-facet-manager/atomic-facet-manager.tsx"],"sourcesContent":["import {NumberValue, Schema} from '@coveo/bueno';\r\nimport {\r\n  FacetManager,\r\n  buildFacetManager,\r\n  FacetManagerState,\r\n} from '@coveo/headless';\r\nimport {Component, h, Element, State, Prop} from '@stencil/core';\r\nimport {\r\n  BindStateToController,\r\n  InitializableComponent,\r\n  InitializeBindings,\r\n} from '../../../utils/initialization-utils';\r\nimport {\r\n  getFacetsInChildren,\r\n  getAutomaticFacetGenerator,\r\n  sortFacetVisibility,\r\n  collapseFacetsAfter,\r\n  BaseFacetElement,\r\n} from '../../common/facets/facet-common';\r\nimport {Bindings} from '../atomic-search-interface/atomic-search-interface';\r\n\r\n/**\r\n * The `atomic-facet-manager` helps reorder facets and their values to match the most recent search response with the most relevant results. A facet component is slotted within an `atomic-facet-manager` to leverage this functionality.\r\n */\r\n@Component({\r\n  tag: 'atomic-facet-manager',\r\n  shadow: false,\r\n})\r\nexport class AtomicFacetManager implements InitializableComponent {\r\n  @InitializeBindings() public bindings!: Bindings;\r\n  private facetManager!: FacetManager;\r\n\r\n  @Element() private host!: HTMLDivElement;\r\n\r\n  @BindStateToController('facetManager', {\r\n    onUpdateCallbackMethod: 'sortFacets',\r\n  })\r\n  @State()\r\n  public facetManagerState!: FacetManagerState;\r\n  @State() public error!: Error;\r\n\r\n  /**\r\n   * The number of expanded facets inside the manager.\r\n   * Remaining facets are automatically collapsed.\r\n   *\r\n   * Using the value `0` collapses all facets.\r\n   * Using the value `-1` disables the feature and keeps all facets expanded. Useful when you want to set the collapse state for each facet individually.\r\n   */\r\n  @Prop({reflect: true}) public collapseFacetsAfter = 4;\r\n\r\n  public initialize() {\r\n    this.validateProps();\r\n    this.facetManager = buildFacetManager(this.bindings.engine);\r\n\r\n    // An update has to be forced for the facets to be visually updated, without being interacted with.\r\n    this.bindings.i18n.on('languageChanged', this.sortFacets);\r\n  }\r\n\r\n  private sortFacets = () => {\r\n    const facets = getFacetsInChildren(this.host);\r\n\r\n    const sortedFacets = this.sortFacetsUsingManager(facets, this.facetManager);\r\n\r\n    const {visibleFacets, invisibleFacets} = sortFacetVisibility(\r\n      sortedFacets,\r\n      this.bindings.store.getAllFacets()\r\n    );\r\n\r\n    const generator = getAutomaticFacetGenerator(this.host);\r\n\r\n    collapseFacetsAfter(visibleFacets, this.collapseFacetsAfter);\r\n\r\n    generator?.updateCollapseFacetsDependingOnFacetsVisibility(\r\n      this.collapseFacetsAfter,\r\n      visibleFacets.length\r\n    );\r\n\r\n    this.host.append(\r\n      ...[\r\n        ...visibleFacets,\r\n        ...invisibleFacets,\r\n        ...(generator ? [generator] : []),\r\n      ]\r\n    );\r\n  };\r\n\r\n  private validateProps() {\r\n    new Schema({\r\n      collapseFacetAfter: new NumberValue({min: -1, required: true}),\r\n    }).validate({\r\n      collapseFacetAfter: this.collapseFacetsAfter,\r\n    });\r\n  }\r\n\r\n  private sortFacetsUsingManager(\r\n    facets: BaseFacetElement[],\r\n    facetManager: FacetManager\r\n  ): BaseFacetElement[] {\r\n    const payload = facets.map((f) => ({\r\n      facetId: f.facetId,\r\n      payload: f,\r\n    }));\r\n    return facetManager.sort(payload).map((f) => f.payload);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    this.bindings.i18n.off('languageChanged', this.sortFacets);\r\n  }\r\n\r\n  public render() {\r\n    return <slot />;\r\n  }\r\n}\r\n"],"version":3}