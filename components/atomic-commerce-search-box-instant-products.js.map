{"file":"atomic-commerce-search-box-instant-products.js","mappings":"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","names":["AtomicCommerceSearchBoxInstantProducts","buildInstantProducts"],"sources":["src/components/commerce/search-box-suggestions/atomic-commerce-search-box-instant-products/atomic-commerce-search-box-instant-products.tsx"],"sourcesContent":["import {\r\n  SearchBox,\r\n  buildInstantProducts,\r\n  Product,\r\n  InstantProducts,\r\n  InteractiveProduct,\r\n  CommerceEngine,\r\n} from '@coveo/headless/commerce';\r\nimport {Component, Element, State, h, Prop, Method} from '@stencil/core';\r\nimport {InitializableComponent} from '../../../../utils/initialization-utils';\r\nimport {encodeForDomAttribute} from '../../../../utils/string-utils';\r\nimport {ItemRenderingFunction} from '../../../common/item-list/item-list-common';\r\nimport {\r\n  ItemDisplayDensity,\r\n  ItemDisplayImageSize,\r\n  ItemDisplayLayout,\r\n} from '../../../common/layout/display-options';\r\nimport {\r\n  getPartialInstantItemElement,\r\n  getPartialInstantItemShowAllElement,\r\n  InstantItemShowAllButton,\r\n} from '../../../common/suggestions/instant-item';\r\nimport {\r\n  dispatchSearchBoxSuggestionsEvent,\r\n  SearchBoxSuggestionElement,\r\n  SearchBoxSuggestions,\r\n  SearchBoxSuggestionsBindings,\r\n} from '../../../common/suggestions/suggestions-common';\r\nimport {CommerceBindings as Bindings} from '../../atomic-commerce-interface/atomic-commerce-interface';\r\nimport {ProductTemplateProvider} from '../../product-list/product-template-provider';\r\n\r\nexport type AriaLabelGenerator = (\r\n  bindings: Bindings,\r\n  product: Product\r\n) => string | undefined;\r\n\r\n// TODO: KIT-3165 Uncomment once the `buildInteractiveInstantProduct` function is implemented in headless.\r\nfunction buildInteractiveInstantProduct(\r\n  _engine: CommerceEngine<{}>,\r\n  _arg: {options: {product: Product}}\r\n): InteractiveProduct {\r\n  return {} as InteractiveProduct;\r\n}\r\n\r\n/**\r\n * The `atomic-commerce-search-box-instant-products` component can be added as a child of an `atomic-search-box` component, allowing for the configuration of instant results behavior.\r\n *\r\n * This component does not support accessibility out-of-the-box. To do so, see [Instant Results Accessibility](https://docs.coveo.com/en/atomic/latest/usage/accessibility/#instant-results-accessibility).\r\n *\r\n * This component is not supported on mobile.\r\n *\r\n * @internal\r\n */\r\n@Component({\r\n  tag: 'atomic-commerce-search-box-instant-products',\r\n  shadow: true,\r\n})\r\nexport class AtomicCommerceSearchBoxInstantProducts\r\n  implements InitializableComponent<Bindings>\r\n{\r\n  public bindings!: SearchBoxSuggestionsBindings<SearchBox, Bindings>;\r\n  private itemRenderingFunction: ItemRenderingFunction;\r\n  private products: Product[] = [];\r\n  private itemTemplateProvider!: ProductTemplateProvider;\r\n  private instantProducts!: InstantProducts;\r\n  private display: ItemDisplayLayout = 'list';\r\n\r\n  @Element() public host!: HTMLElement;\r\n\r\n  @State() public error!: Error;\r\n  @State() private templateHasError = false;\r\n\r\n  /**\r\n   * Sets a rendering function to bypass the standard HTML template mechanism for rendering results.\r\n   * You can use this function while working with web frameworks that don't use plain HTML syntax, e.g., React, Angular or Vue.\r\n   *\r\n   * Do not use this method if you integrate Atomic in a plain HTML deployment.\r\n   *\r\n   * @param resultRenderingFunction\r\n   */\r\n  @Method() public async setRenderFunction(\r\n    resultRenderingFunction: ItemRenderingFunction\r\n  ) {\r\n    this.itemRenderingFunction = resultRenderingFunction;\r\n  }\r\n  /**\r\n   * The spacing of various elements in the product list, including the gap between products, the gap between parts of a product, and the font sizes of different parts in a product.\r\n   */\r\n  @Prop({reflect: true}) public density: ItemDisplayDensity = 'normal';\r\n  /**\r\n   * The expected size of the image displayed in the products.\r\n   */\r\n  @Prop({reflect: true}) public imageSize: ItemDisplayImageSize = 'icon';\r\n  /**\r\n   * The callback to generate an [`aria-label`](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Attributes/aria-label) for a given product so that accessibility tools can fully describe what's visually rendered by a product.\r\n   *\r\n   * By default, or if an empty string is returned, `product.ec_name` is used.\r\n   */\r\n  @Prop() public ariaLabelGenerator?: AriaLabelGenerator;\r\n\r\n  public componentWillLoad() {\r\n    try {\r\n      dispatchSearchBoxSuggestionsEvent<SearchBox, Bindings>((bindings) => {\r\n        this.bindings = bindings;\r\n        return this.initialize();\r\n      }, this.host);\r\n    } catch (error) {\r\n      this.error = error as Error;\r\n    }\r\n  }\r\n\r\n  private getLink(el: HTMLElement): HTMLElement | null {\r\n    const atomicProduct =\r\n      el.tagName === 'ATOMIC-PRODUCT'\r\n        ? el\r\n        : el?.querySelector('atomic-product');\r\n\r\n    return (\r\n      atomicProduct?.shadowRoot?.querySelector('atomic-product-link a') || null\r\n    );\r\n  }\r\n\r\n  private handleLinkClick(el: HTMLElement, hasModifier: boolean) {\r\n    const setTarget = (value: string) => el.setAttribute('target', value);\r\n    const initialTarget = el.getAttribute('target');\r\n\r\n    hasModifier && setTarget('_blank');\r\n    el.click();\r\n    hasModifier && setTarget(initialTarget || '');\r\n\r\n    return true;\r\n  }\r\n\r\n  private renderItems(): SearchBoxSuggestionElement[] {\r\n    if (!this.bindings.suggestedQuery() || this.bindings.store.isMobile()) {\r\n      return [];\r\n    }\r\n    const products = this.instantProducts.state.products.length\r\n      ? this.instantProducts.state.products\r\n      : this.products;\r\n\r\n    const elements: SearchBoxSuggestionElement[] = products.map(\r\n      (product: Product) => {\r\n        const partialItem = getPartialInstantItemElement(\r\n          this.bindings.i18n,\r\n          this.ariaLabelGenerator?.(this.bindings, product) || product.ec_name!,\r\n          product.permanentid\r\n        );\r\n        return {\r\n          ...partialItem,\r\n          content: (\r\n            <atomic-product\r\n              key={`instant-product-${encodeForDomAttribute(product.permanentid)}`}\r\n              part=\"outline\"\r\n              product={product}\r\n              interactiveProduct={buildInteractiveInstantProduct(\r\n                this.bindings.engine,\r\n                {\r\n                  options: {product},\r\n                }\r\n              )}\r\n              display={this.display}\r\n              density={this.density}\r\n              imageSize={this.imageSize}\r\n              content={this.itemTemplateProvider.getTemplateContent(product)}\r\n              stopPropagation={false}\r\n              renderingFunction={this.itemRenderingFunction}\r\n            ></atomic-product>\r\n          ),\r\n          onSelect: (e: MouseEvent) => {\r\n            const link = this.getLink(e.target as HTMLElement);\r\n\r\n            if (!link) {\r\n              return;\r\n            }\r\n            this.handleLinkClick(link, e.ctrlKey || e.metaKey);\r\n          },\r\n        };\r\n      }\r\n    );\r\n    if (elements.length) {\r\n      const partialItem = getPartialInstantItemShowAllElement(\r\n        this.bindings.i18n\r\n      );\r\n      elements.push({\r\n        ...partialItem,\r\n        content: <InstantItemShowAllButton i18n={this.bindings.i18n} />,\r\n        onSelect: () => {\r\n          this.bindings.clearSuggestions();\r\n          this.bindings.searchBoxController.updateText(\r\n            this.instantProducts.state.query\r\n          );\r\n          this.bindings.searchBoxController.submit();\r\n        },\r\n      });\r\n    }\r\n    return elements;\r\n  }\r\n\r\n  public initialize(): SearchBoxSuggestions {\r\n    this.instantProducts = buildInstantProducts(this.bindings.engine, {\r\n      options: {},\r\n    });\r\n\r\n    this.itemTemplateProvider = new ProductTemplateProvider({\r\n      includeDefaultTemplate: true,\r\n      templateElements: Array.from(\r\n        this.host.querySelectorAll('atomic-product-template')\r\n      ),\r\n      getResultTemplateRegistered: () => true,\r\n      setResultTemplateRegistered: () => {},\r\n      getTemplateHasError: () => this.templateHasError,\r\n      setTemplateHasError: (value: boolean) => {\r\n        this.templateHasError = value;\r\n      },\r\n    });\r\n\r\n    return {\r\n      position: Array.from(this.host.parentNode!.children).indexOf(this.host),\r\n      panel: 'right',\r\n      onSuggestedQueryChange: (q) => {\r\n        this.instantProducts.updateQuery(q);\r\n        return this.onSuggestedQueryChange();\r\n      },\r\n      renderItems: () => this.renderItems(),\r\n    };\r\n  }\r\n\r\n  private onSuggestedQueryChange() {\r\n    if (\r\n      !this.bindings.getSuggestionElements().length &&\r\n      !this.bindings.searchBoxController.state.value\r\n    ) {\r\n      console.warn(\r\n        \"There doesn't seem to be any query suggestions configured. Make sure to include either an atomic-commerce-search-box-query-suggestions or atomic-commerce-search-box-recent-queries in your search box in order to see some instant products.\"\r\n      );\r\n    }\r\n\r\n    return new Promise<void>((resolve) => {\r\n      const unsubscribe = this.instantProducts.subscribe(() => {\r\n        const state = this.instantProducts.state;\r\n        if (!state.isLoading) {\r\n          if (state.products.length) {\r\n            this.products = state.products;\r\n          }\r\n          unsubscribe();\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  public render() {\r\n    if (this.error) {\r\n      return (\r\n        <atomic-component-error\r\n          element={this.host}\r\n          error={this.error}\r\n        ></atomic-component-error>\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"version":3}