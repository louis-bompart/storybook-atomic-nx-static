{"version":3,"names":["getTemplateNodeType","node","isResultSectionNode","isVisualNode","isElementNode","tagName","toLowerCase","tableElementTagName","groupNodesByType","nodes","aggregate","Array","from","ProductTemplateCommon","constructor","host","setError","validParents","allowEmpty","this","matchConditions","validateTemplate","hasValidParent","map","p","toUpperCase","includes","_a","parentElement","nodeName","Error","join","template","querySelector","innerHTML","trim","content","console","warn","section","sectionNodes","other","otherNodes","childNodes","length","getTemplate","conditions","error","concat","getTemplateElement","priority","renderIfError","h","element","makeMatchConditions","mustMatch","mustNotMatch","field","push","ProductTemplatesHelpers","fieldMustMatch","fieldMustNotMatch","AtomicProductTemplate","hostRef","productTemplateCommon","err","componentWillLoad","render","__decorate","MapProp","splitValues"],"sources":["src/components/commerce/product-template/product-template-common.tsx","src/components/commerce/product-template/atomic-product-template.tsx"],"sourcesContent":["import {\n  ProductTemplate,\n  ProductTemplateCondition,\n  ProductTemplatesHelpers,\n} from '@coveo/headless/commerce';\nimport {h} from '@stencil/core';\nimport {aggregate, isElementNode, isVisualNode} from '../../../utils/utils';\nimport {isResultSectionNode} from '../../common/layout/sections';\nimport {tableElementTagName} from '../../search/atomic-table-result/table-element-utils';\n\nexport type TemplateContent = DocumentFragment;\n\ninterface ProductTemplateCommonProps {\n  allowEmpty?: boolean;\n  host: HTMLDivElement;\n  validParents: string[];\n  setError: (error: Error) => void;\n}\n\ntype TemplateNodeType =\n  | 'section'\n  | 'metadata'\n  | 'table-column-definition'\n  | 'other';\n\nexport function getTemplateNodeType(node: Node): TemplateNodeType {\n  if (isResultSectionNode(node)) {\n    return 'section';\n  }\n  if (!isVisualNode(node)) {\n    return 'metadata';\n  }\n  if (\n    isElementNode(node) &&\n    node.tagName.toLowerCase() === tableElementTagName\n  ) {\n    return 'table-column-definition';\n  }\n  return 'other';\n}\n\nfunction groupNodesByType(nodes: NodeList) {\n  return aggregate(Array.from(nodes), (node) => getTemplateNodeType(node));\n}\n\nexport class ProductTemplateCommon {\n  private host: HTMLDivElement;\n  public matchConditions: ProductTemplateCondition[] = [];\n\n  constructor({\n    host,\n    setError,\n    validParents,\n    allowEmpty = false,\n  }: ProductTemplateCommonProps) {\n    this.host = host;\n    this.validateTemplate(host, setError, validParents, allowEmpty);\n  }\n\n  validateTemplate(\n    host: HTMLDivElement,\n    setError: (error: Error) => void,\n    validParents: string[],\n    allowEmpty = true\n  ) {\n    const hasValidParent = validParents\n      .map((p) => p.toUpperCase())\n      .includes(host.parentElement?.nodeName || '');\n    const tagName = host.nodeName.toLowerCase();\n\n    if (!hasValidParent) {\n      setError(\n        new Error(\n          `The \"${tagName}\" component has to be the child of one of the following: ${validParents\n            .map((p) => `\"${p.toLowerCase()}\"`)\n            .join(', ')}.`\n        )\n      );\n      return;\n    }\n\n    const template = host.querySelector('template');\n    if (!template) {\n      setError(\n        new Error(\n          `The \"${tagName}\" component must contain a \"template\" element as a child.`\n        )\n      );\n      return;\n    }\n\n    if (!allowEmpty && !template.innerHTML.trim()) {\n      setError(\n        new Error(`The \"template\" tag inside \"${tagName}\" cannot be empty.`)\n      );\n      return;\n    }\n\n    if (template.content.querySelector('script')) {\n      console.warn(\n        'Any \"script\" tags defined inside of \"template\" elements are not supported and will not be executed when the products are rendered.',\n        host\n      );\n    }\n\n    const {section: sectionNodes, other: otherNodes} = groupNodesByType(\n      template.content.childNodes\n    );\n    if (sectionNodes?.length && otherNodes?.length) {\n      console.warn(\n        'Product templates should only contain section elements or non-section elements. Future updates could unpredictably affect this product template.',\n        host,\n        {sectionNodes, otherNodes}\n      );\n    }\n  }\n\n  getTemplate(\n    conditions: ProductTemplateCondition[],\n    error: Error\n  ): ProductTemplate<TemplateContent> | null {\n    if (error) {\n      return null;\n    }\n\n    return {\n      conditions: conditions.concat(this.matchConditions),\n      content: getTemplateElement(this.host).content!,\n      priority: 1,\n    };\n  }\n\n  renderIfError(error: Error) {\n    if (error) {\n      return (\n        <atomic-component-error\n          element={this.host}\n          error={error}\n        ></atomic-component-error>\n      );\n    }\n  }\n}\n\nfunction getTemplateElement(host: HTMLElement) {\n  return host.querySelector('template')!;\n}\nexport function makeMatchConditions(\n  mustMatch: Record<string, string[]>,\n  mustNotMatch: Record<string, string[]>\n): ProductTemplateCondition[] {\n  const conditions: ProductTemplateCondition[] = [];\n  for (const field in mustMatch) {\n    conditions.push(\n      ProductTemplatesHelpers.fieldMustMatch(field, mustMatch[field])\n    );\n  }\n\n  for (const field in mustNotMatch) {\n    conditions.push(\n      ProductTemplatesHelpers.fieldMustNotMatch(field, mustNotMatch[field])\n    );\n  }\n  return conditions;\n}\n\nexport function makeDefinedConditions(\n  ifDefined?: string,\n  ifNotDefined?: string\n): ProductTemplateCondition[] {\n  const conditions: ProductTemplateCondition[] = [];\n  if (ifDefined) {\n    const fieldNames = ifDefined.split(',');\n    conditions.push(ProductTemplatesHelpers.fieldsMustBeDefined(fieldNames));\n  }\n\n  if (ifNotDefined) {\n    const fieldNames = ifNotDefined.split(',');\n    conditions.push(ProductTemplatesHelpers.fieldsMustNotBeDefined(fieldNames));\n  }\n  return conditions;\n}\n","import {\n  ProductTemplate,\n  ProductTemplateCondition,\n} from '@coveo/headless/commerce';\nimport {Component, Element, Prop, Method, State} from '@stencil/core';\nimport {MapProp} from '../../../utils/props-utils';\nimport {\n  ProductTemplateCommon,\n  makeMatchConditions,\n} from './product-template-common';\n\n/**\n * @internal\n */\n@Component({\n  tag: 'atomic-product-template',\n  shadow: true,\n})\nexport class AtomicProductTemplate {\n  private productTemplateCommon: ProductTemplateCommon;\n\n  @State() public error!: Error;\n\n  @Element() public host!: HTMLDivElement;\n\n  /**\n   * A function that must return true on products for the product template to apply.\n   * Set programmatically before initialization, not via attribute.\n   *\n   * For example, the following targets a template and sets a condition to make it apply only to products whose `ec_name` contains `singapore`:\n   * `document.querySelector('#target-template').conditions = [(product) => /singapore/i.test(product.ec_name)];`\n   */\n  @Prop() public conditions: ProductTemplateCondition[] = [];\n\n  @MapProp({splitValues: true}) public mustMatch: Record<string, string[]> = {};\n\n  @MapProp({splitValues: true}) public mustNotMatch: Record<string, string[]> =\n    {};\n\n  constructor() {\n    this.productTemplateCommon = new ProductTemplateCommon({\n      host: this.host,\n      setError: (err) => {\n        this.error = err;\n      },\n      validParents: [\n        'atomic-commerce-product-list',\n        'atomic-commerce-recommendation-list',\n      ],\n      allowEmpty: true,\n    });\n  }\n\n  public componentWillLoad() {\n    this.productTemplateCommon.matchConditions = makeMatchConditions(\n      this.mustMatch,\n      this.mustNotMatch\n    );\n  }\n\n  /**\n   * Gets the product template to apply based on the evaluated conditions.\n   */\n  @Method()\n  public async getTemplate(): Promise<ProductTemplate<DocumentFragment> | null> {\n    return this.productTemplateCommon.getTemplate(this.conditions, this.error);\n  }\n\n  public render() {\n    return this.productTemplateCommon.renderIfError(this.error);\n  }\n}\n"],"mappings":"6SAyBgBA,EAAoBC,GAClC,GAAIC,EAAoBD,GAAO,CAC7B,MAAO,S,CAET,IAAKE,EAAaF,GAAO,CACvB,MAAO,U,CAET,GACEG,EAAcH,IACdA,EAAKI,QAAQC,gBAAkBC,EAC/B,CACA,MAAO,yB,CAET,MAAO,OACT,CAEA,SAASC,EAAiBC,GACxB,OAAOC,EAAUC,MAAMC,KAAKH,IAASR,GAASD,EAAoBC,IACpE,C,MAEaY,EAIX,WAAAC,EAAYC,KACVA,EAAIC,SACJA,EAAQC,aACRA,EAAYC,WACZA,EAAa,QANRC,KAAAC,gBAA8C,GAQnDD,KAAKJ,KAAOA,EACZI,KAAKE,iBAAiBN,EAAMC,EAAUC,EAAcC,E,CAGtD,gBAAAG,CACEN,EACAC,EACAC,EACAC,EAAa,M,MAEb,MAAMI,EAAiBL,EACpBM,KAAKC,GAAMA,EAAEC,gBACbC,WAASC,EAAAZ,EAAKa,iBAAa,MAAAD,SAAA,SAAAA,EAAEE,WAAY,IAC5C,MAAMxB,EAAUU,EAAKc,SAASvB,cAE9B,IAAKgB,EAAgB,CACnBN,EACE,IAAIc,MACF,QAAQzB,6DAAmEY,EACxEM,KAAKC,GAAM,IAAIA,EAAElB,mBACjByB,KAAK,WAGZ,M,CAGF,MAAMC,EAAWjB,EAAKkB,cAAc,YACpC,IAAKD,EAAU,CACbhB,EACE,IAAIc,MACF,QAAQzB,+DAGZ,M,CAGF,IAAKa,IAAec,EAASE,UAAUC,OAAQ,CAC7CnB,EACE,IAAIc,MAAM,8BAA8BzB,wBAE1C,M,CAGF,GAAI2B,EAASI,QAAQH,cAAc,UAAW,CAC5CI,QAAQC,KACN,qIACAvB,E,CAIJ,MAAOwB,QAASC,EAAcC,MAAOC,GAAclC,EACjDwB,EAASI,QAAQO,YAEnB,IAAIH,IAAY,MAAZA,SAAY,SAAZA,EAAcI,UAAUF,IAAU,MAAVA,SAAU,SAAVA,EAAYE,QAAQ,CAC9CP,QAAQC,KACN,mJACAvB,EACA,CAACyB,eAAcE,c,EAKrB,WAAAG,CACEC,EACAC,GAEA,GAAIA,EAAO,CACT,OAAO,I,CAGT,MAAO,CACLD,WAAYA,EAAWE,OAAO7B,KAAKC,iBACnCgB,QAASa,EAAmB9B,KAAKJ,MAAMqB,QACvCc,SAAU,E,CAId,aAAAC,CAAcJ,GACZ,GAAIA,EAAO,CACT,OACEK,EAAA,0BACEC,QAASlC,KAAKJ,KACdgC,MAAOA,G,GAOjB,SAASE,EAAmBlC,GAC1B,OAAOA,EAAKkB,cAAc,WAC5B,C,SACgBqB,EACdC,EACAC,GAEA,MAAMV,EAAyC,GAC/C,IAAK,MAAMW,KAASF,EAAW,CAC7BT,EAAWY,KACTC,EAAwBC,eAAeH,EAAOF,EAAUE,I,CAI5D,IAAK,MAAMA,KAASD,EAAc,CAChCV,EAAWY,KACTC,EAAwBE,kBAAkBJ,EAAOD,EAAaC,I,CAGlE,OAAOX,CACT,C,iXClJagB,EAAqB,MAqBhC,WAAAhD,CAAAiD,G,UAPe5C,KAAA2B,WAAyC,GAEnB3B,KAAAoC,UAAsC,GAEtCpC,KAAAqC,aACnC,G,qCALsD,GAQtDrC,KAAK6C,sBAAwB,IAAInD,EAAsB,CACrDE,KAAMI,KAAKJ,KACXC,SAAWiD,IACT9C,KAAK4B,MAAQkB,CAAG,EAElBhD,aAAc,CACZ,+BACA,uCAEFC,WAAY,M,CAIT,iBAAAgD,GACL/C,KAAK6C,sBAAsB5C,gBAAkBkC,EAC3CnC,KAAKoC,UACLpC,KAAKqC,a,CAQF,iBAAMX,GACX,OAAO1B,KAAK6C,sBAAsBnB,YAAY1B,KAAK2B,WAAY3B,KAAK4B,M,CAG/D,MAAAoB,GACL,OAAOhD,KAAK6C,sBAAsBb,cAAchC,KAAK4B,M,6BAnClBqB,EAAA,CAApCC,EAAQ,CAACC,YAAa,Q,gCAEcF,EAAA,CAApCC,EAAQ,CAACC,YAAa,Q"}