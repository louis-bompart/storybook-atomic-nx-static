{"version":3,"names":["identifierKeywordsSection","QuickviewSidebar","props","words","minimized","numberOfWords","Object","values","length","minimizeButton","h","MinimizeButton","wordsLength","class","HighlightKeywordsCheckbox","Keywords","i18n","onMinimize","highlightKeywords","IconButton","partPrefix","icon","MinimizeIcon","style","title","t","ariaLabel","onClick","badge","undefined","ariaExpanded","toString","ariaControls","onHighlightKeywords","Fragment","Checkbox","text","id","checked","highlightNone","onToggle","htmlFor","map","keyword","wordIsEnabled","keywords","enabled","key","backgroundColor","color","Intl","NumberFormat","language","notation","format","occurrences","FieldsetGroup","label","ArrowDown","disabled","navigateForward","ArrowUp","navigateBackward","tabIndex","ariaPressed","Remove","Add","indexIdentifier","documentIdentifierInIframe","writeDocument","documentWriter","content","open","write","close","scrollingElement","scrollTop","currentResultAlreadyWrittenToDocument","uniqueIdentifier","currentDocIdentifier","getElementById","textContent","ensureSameResultIsNotOverwritten","docIdentifier","createElement","display","setAttribute","body","appendChild","warnAboutLimitedUsageQuickview","logger","warn","QuickviewIframe","onSetIframeRef","sandbox","src","waitForIframeContentToBeWritten","Promise","resolve","setTimeout","ref","async","el","iframeRef","contentDocument","buildPreviewBar","previewBarId","bar","innerHTML","position","top","right","width","height","buildPreviewUnit","word","wordElement","docHeight","previewUnit","_a","elementPosition","getBoundingClientRect","border","previewBorderColor","buildQuickviewPreviewBar","iframe","remove","scrollHeight","forEach","elements","rgbToHsv","r","g","b","max","Math","min","v","d","s","hsvToRgb","i","floor","f","p","q","round","HIGHLIGHT_PREFIX","QuickviewWordHighlight","constructor","stemmingInfoFromIndex","keywordElementInIframe","this","currentNavigationPosition","parsed","parseKeywordIdentifier","getText","keywordIdentifier","focusedColor","computeInvertedColor","computeSaturatedColor","addElement","push","highlightNavigation","putElementIntoView","isTaggedWord","element","nodeName","toLowerCase","currentElement","otherElements","filter","scrollIntoView","innerTextOfHTMLElement","getHighlightedInnerText","resolveOriginalTerm","trim","highlight","found","keys","find","originalTerm","originalTermMatch","stemmingExpansions","stemmingExpansionMatch","stemmingExpansion","getTextOfHTMLElement","children","Array","from","parts","substring","match","keywordTermPart","parseInt","innerText","extractRgb","newSaturation","rSaturated","gSaturated","bSaturated","rgbExtracted","getWordsHighlights","wordsHighlights","querySelectorAll","wordHTMLElementToHighlight","wordHighlight","alreadyScannedKeyword","atomicQuickviewModalCss","AtomicQuickviewModalStyle0","AtomicQuickviewModal","minimizeSidebar","watchHighlightKeywords","handleHighlightsScripts","componentWillRender","bindings","store","isMobile","reset","result","interactiveResult","renderHeader","headerContent","buildInteractiveResult","engine","options","LinkWithItemAnalytics","href","clickUri","onSelect","select","onBeginDelayedSelect","beginDelayedSelect","onCancelPendingSelect","cancelPendingSelect","className","part","CloseIcon","onClose","slot","renderBody","minimize","quickviewSrc","quickviewUniqueIdentifier","termsToHighlight","renderFooter","Button","previousQuickview","emit","first","current","total","nextQuickview","modalCloseCallback","isOpen","highlightScriptId","state","resultPreview","contentURL","enableHighlights","removeDisableHighlightScript","enableHighlightsSpecificKeyword","identifier","disableHighlights","createDisableHighlightScript","disableHighlightsSpecificKeyword","doc","_b","contentWindow","document","_c","head","scriptId","createStyleElement","createTextNode","flatPhrasesToHighlight","phrasesToHighlight","search","response","entries","phrase","flatMap","keywordEntry","keywordStemming","requestId","uniqueId","render","fullscreen","__decorate","InitializeBindings"],"sources":["src/components/search/result-template-components/atomic-quickview-sidebar/atomic-quickview-sidebar.tsx","src/components/search/result-template-components/quickview-iframe/quickview-iframe.tsx","src/components/search/result-template-components/quickview-preview-bar/quickview-preview-bar.ts","src/utils/color-utils.ts","src/components/search/result-template-components/quickview-word-highlight/quickview-word-highlight.tsx","src/components/search/result-template-components/atomic-quickview-modal/atomic-quickview-modal.pcss?tag=atomic-quickview-modal&encapsulation=shadow","src/components/search/result-template-components/atomic-quickview-modal/atomic-quickview-modal.tsx"],"sourcesContent":["import {Fragment, FunctionalComponent, h} from '@stencil/core';\r\nimport {i18n} from 'i18next';\r\nimport Add from '../../../../images/add.svg';\r\nimport ArrowDown from '../../../../images/arrow-bottom-rounded.svg';\r\nimport ArrowUp from '../../../../images/arrow-top-rounded.svg';\r\nimport MinimizeIcon from '../../../../images/menu.svg';\r\nimport Remove from '../../../../images/remove.svg';\r\nimport {Checkbox} from '../../../common/checkbox';\r\nimport {FieldsetGroup} from '../../../common/fieldset-group';\r\nimport {IconButton} from '../../../common/iconButton';\r\nimport type {HighlightKeywords} from '../atomic-quickview-modal/atomic-quickview-modal';\r\nimport {QuickviewWordHighlight} from '../quickview-word-highlight/quickview-word-highlight';\r\n\r\nconst identifierKeywordsSection = 'coveo-quickview-sidebar-keywords';\r\n\r\nexport interface QuickviewSidebarProps {\r\n  words: Record<string, QuickviewWordHighlight>;\r\n  i18n: i18n;\r\n  highlightKeywords: HighlightKeywords;\r\n  onHighlightKeywords: (highlight: HighlightKeywords) => void;\r\n  minimized: boolean;\r\n  onMinimize: (minimize: boolean) => void;\r\n}\r\n\r\nexport const QuickviewSidebar: FunctionalComponent<QuickviewSidebarProps> = (\r\n  props\r\n) => {\r\n  const {words, minimized} = props;\r\n  const numberOfWords = Object.values(words).length;\r\n\r\n  if (numberOfWords === 0) {\r\n    return;\r\n  }\r\n\r\n  const minimizeButton = (\r\n    <MinimizeButton {...props} wordsLength={numberOfWords} />\r\n  );\r\n\r\n  return (\r\n    <div class=\"p-4 border-r border-neutral h-full\">\r\n      {minimized && minimizeButton}\r\n      <div class=\"flex items-center justify-between\">\r\n        <div class=\"flex items-center\">\r\n          <HighlightKeywordsCheckbox {...props} />\r\n        </div>\r\n        {!minimized && <div>{minimizeButton}</div>}\r\n      </div>\r\n\r\n      {!minimized && <Keywords {...props} words={words} />}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst MinimizeButton: FunctionalComponent<\r\n  Pick<\r\n    QuickviewSidebarProps,\r\n    'i18n' | 'minimized' | 'onMinimize' | 'highlightKeywords'\r\n  > & {wordsLength: number}\r\n> = ({i18n, minimized, onMinimize, highlightKeywords, wordsLength}) => (\r\n  <IconButton\r\n    partPrefix=\"sidebar-minimize\"\r\n    icon={MinimizeIcon}\r\n    style=\"text-transparent\"\r\n    title={i18n.t('quickview-toggle-navigation')}\r\n    ariaLabel={i18n.t('quickview-toggle-navigation')}\r\n    onClick={() => onMinimize(!minimized)}\r\n    badge={\r\n      highlightKeywords && minimized ? <slot>{wordsLength}</slot> : undefined\r\n    }\r\n    class={`w-fit ${minimized ? '' : 'ml-auto'}`}\r\n    ariaExpanded={(!minimized).toString()}\r\n    ariaControls={identifierKeywordsSection}\r\n  />\r\n);\r\n\r\nconst HighlightKeywordsCheckbox: FunctionalComponent<\r\n  Pick<\r\n    QuickviewSidebarProps,\r\n    'i18n' | 'highlightKeywords' | 'onHighlightKeywords' | 'minimized'\r\n  >\r\n> = ({i18n, highlightKeywords, onHighlightKeywords, minimized}) => (\r\n  <Fragment>\r\n    <Checkbox\r\n      text={i18n.t('keywords-highlight')}\r\n      class=\"mr-2\"\r\n      id=\"atomic-quickview-sidebar-highlight-keywords\"\r\n      checked={!highlightKeywords.highlightNone}\r\n      onToggle={(checked) =>\r\n        onHighlightKeywords({\r\n          ...highlightKeywords,\r\n          highlightNone: !checked,\r\n        })\r\n      }\r\n    ></Checkbox>\r\n    {!minimized && (\r\n      <label\r\n        class=\"font-bold cursor-pointer whitespace-nowrap\"\r\n        htmlFor=\"atomic-quickview-sidebar-highlight-keywords\"\r\n      >\r\n        {i18n.t('keywords-highlight')}\r\n      </label>\r\n    )}\r\n  </Fragment>\r\n);\r\n\r\nconst Keywords: FunctionalComponent<\r\n  Pick<\r\n    QuickviewSidebarProps,\r\n    'i18n' | 'onHighlightKeywords' | 'highlightKeywords'\r\n  > & {\r\n    words: Record<string, QuickviewWordHighlight>;\r\n  }\r\n> = ({words, i18n, highlightKeywords, onHighlightKeywords}) => {\r\n  return (\r\n    <div id={identifierKeywordsSection}>\r\n      {Object.values(words).map((keyword) => {\r\n        const wordIsEnabled =\r\n          !highlightKeywords.highlightNone &&\r\n          (highlightKeywords.keywords[keyword.text] === undefined ||\r\n            highlightKeywords.keywords[keyword.text].enabled === true);\r\n\r\n        return (\r\n          <div\r\n            key={keyword.text}\r\n            class=\"flex items-center justify-between gap-x-2 my-4 w-100\"\r\n          >\r\n            <div\r\n              class={`flex grow items-center bg-background border border-neutral rounded-lg overflow-x-auto ${\r\n                !wordIsEnabled ? 'pointer-events-none opacity-50' : ''\r\n              }`}\r\n            >\r\n              <div\r\n                class=\"flex items-center grow p-4 border-r\"\r\n                aria-hidden=\"true\"\r\n              >\r\n                <div\r\n                  class=\"w-5 h-5 flex-none mr-2\"\r\n                  style={{backgroundColor: keyword.color}}\r\n                ></div>\r\n                <div class=\"grow mr-2 whitespace-nowrap\">{keyword.text}</div>\r\n                <div class=\"flex-none\">\r\n                  (\r\n                  {new Intl.NumberFormat(i18n.language, {\r\n                    notation: 'compact',\r\n                  }).format(keyword.occurrences)}\r\n                  )\r\n                </div>\r\n              </div>\r\n              <FieldsetGroup\r\n                label={i18n.t('quickview-navigate-keywords', {\r\n                  occurrences: keyword.occurrences,\r\n                  keyword: keyword.text,\r\n                })}\r\n              >\r\n                <div class=\"flex px-2\">\r\n                  <IconButton\r\n                    partPrefix=\"sidebar-next\"\r\n                    icon={ArrowDown}\r\n                    disabled={!wordIsEnabled}\r\n                    style=\"text-transparent\"\r\n                    class=\"border-0\"\r\n                    ariaLabel={i18n.t('next')}\r\n                    title={i18n.t('next')}\r\n                    onClick={() => keyword.navigateForward()}\r\n                  />\r\n                  <IconButton\r\n                    partPrefix=\"sidebar-previous\"\r\n                    icon={ArrowUp}\r\n                    disabled={!wordIsEnabled}\r\n                    style=\"text-transparent\"\r\n                    class=\"border-0\"\r\n                    ariaLabel={i18n.t('previous')}\r\n                    title={i18n.t('previous')}\r\n                    onClick={() => keyword.navigateBackward()}\r\n                  />\r\n                </div>\r\n              </FieldsetGroup>\r\n            </div>\r\n            <IconButton\r\n              partPrefix=\"sidebar-remove-word\"\r\n              class={`${\r\n                highlightKeywords.highlightNone\r\n                  ? 'pointer-events-none opacity-50'\r\n                  : ''\r\n              }`}\r\n              tabIndex={highlightKeywords.highlightNone ? '-1' : '0'}\r\n              ariaPressed={(!wordIsEnabled).toString()}\r\n              style=\"text-transparent\"\r\n              icon={wordIsEnabled ? Remove : Add}\r\n              ariaLabel={i18n.t('quickview-remove-word')}\r\n              onClick={() => {\r\n                onHighlightKeywords({\r\n                  ...highlightKeywords,\r\n                  keywords: {\r\n                    ...highlightKeywords.keywords,\r\n                    [keyword.text]: {\r\n                      enabled: !wordIsEnabled,\r\n                      indexIdentifier: keyword.indexIdentifier,\r\n                    },\r\n                  },\r\n                });\r\n              }}\r\n            />\r\n          </div>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n};\r\n","import {SearchEngine} from '@coveo/headless';\r\nimport {FunctionalComponent, h} from '@stencil/core';\r\n\r\nconst documentIdentifierInIframe = 'CoveoDocIdentifier';\r\n\r\nconst writeDocument = (documentWriter: Document, content: string) => {\r\n  documentWriter.open();\r\n  documentWriter.write(content);\r\n  documentWriter.close();\r\n  if (documentWriter.scrollingElement) {\r\n    documentWriter.scrollingElement.scrollTop = 0;\r\n  }\r\n};\r\n\r\nconst currentResultAlreadyWrittenToDocument = (\r\n  documentWriter: Document,\r\n  uniqueIdentifier: string\r\n) => {\r\n  const currentDocIdentifier = documentWriter.getElementById(\r\n    documentIdentifierInIframe\r\n  );\r\n\r\n  return (\r\n    currentDocIdentifier &&\r\n    currentDocIdentifier.textContent === uniqueIdentifier\r\n  );\r\n};\r\n\r\nconst ensureSameResultIsNotOverwritten = (\r\n  documentWriter: Document,\r\n  uniqueIdentifier: string\r\n) => {\r\n  const docIdentifier = documentWriter.createElement('div');\r\n  docIdentifier.style.display = 'none';\r\n  docIdentifier.setAttribute('aria-hidden', 'true');\r\n  docIdentifier.id = documentIdentifierInIframe;\r\n  docIdentifier.textContent = uniqueIdentifier;\r\n  documentWriter.body.appendChild(docIdentifier);\r\n};\r\n\r\nconst warnAboutLimitedUsageQuickview = (logger?: SearchEngine['logger']) => {\r\n  logger?.warn(\r\n    'Quickview initialized in restricted mode due to incompatible sandboxing environment. Keywords hit navigation will be disabled.'\r\n  );\r\n};\r\n\r\nexport const QuickviewIframe: FunctionalComponent<{\r\n  content?: string;\r\n  onSetIframeRef: (ref: HTMLIFrameElement) => void;\r\n  uniqueIdentifier?: string;\r\n  sandbox?: string;\r\n  src?: string;\r\n  logger?: SearchEngine['logger'];\r\n}> = ({onSetIframeRef, uniqueIdentifier, content, sandbox, src, logger}) => {\r\n  // When a document is written with document.open/document.write/document.close\r\n  // it is not synchronous and the content of the iframe is only available to be queried at the end of the current call stack.\r\n  // This add a \"wait\" (setTimeout 0) before calling the `onSetIframeRef` from the parent modal quickview\r\n  const waitForIframeContentToBeWritten = () => {\r\n    return new Promise((resolve) => setTimeout(resolve));\r\n  };\r\n\r\n  return (\r\n    <iframe\r\n      src=\"about:blank\"\r\n      class=\"w-full h-full\"\r\n      sandbox={sandbox}\r\n      ref={async (el) => {\r\n        const iframeRef = el as HTMLIFrameElement;\r\n\r\n        if (!uniqueIdentifier || !content) {\r\n          return;\r\n        }\r\n\r\n        const documentWriter = iframeRef.contentDocument;\r\n        if (!documentWriter) {\r\n          if (src) {\r\n            warnAboutLimitedUsageQuickview(logger);\r\n            iframeRef.src = src;\r\n          }\r\n\r\n          return;\r\n        }\r\n        if (\r\n          currentResultAlreadyWrittenToDocument(\r\n            documentWriter,\r\n            uniqueIdentifier\r\n          )\r\n        ) {\r\n          return;\r\n        }\r\n\r\n        writeDocument(documentWriter, content);\r\n        ensureSameResultIsNotOverwritten(documentWriter, uniqueIdentifier);\r\n\r\n        await waitForIframeContentToBeWritten();\r\n        onSetIframeRef(iframeRef);\r\n      }}\r\n    ></iframe>\r\n  );\r\n};\r\n","import {HighlightKeywords} from '../atomic-quickview-modal/atomic-quickview-modal';\r\nimport {QuickviewWordHighlight} from '../quickview-word-highlight/quickview-word-highlight';\r\n\r\nconst buildPreviewBar = (documentWriter: Document) => {\r\n  const previewBarId = 'CoveoPreviewBar';\r\n  const bar =\r\n    documentWriter.getElementById(previewBarId) ||\r\n    documentWriter.createElement('div');\r\n\r\n  bar.id = previewBarId;\r\n  bar.innerHTML = '';\r\n  bar.style.position = 'fixed';\r\n  bar.style.top = '0';\r\n  bar.style.right = '0';\r\n  bar.style.width = '15px';\r\n  bar.style.height = '100%';\r\n  bar.setAttribute('aria-hidden', 'true');\r\n  return bar;\r\n};\r\n\r\nconst buildPreviewUnit = (\r\n  documentWriter: Document,\r\n  word: QuickviewWordHighlight,\r\n  wordElement: HTMLElement,\r\n  docHeight: number,\r\n  highlightKeywords: HighlightKeywords\r\n) => {\r\n  const previewUnit = documentWriter.createElement('div');\r\n  if (highlightKeywords.keywords[word.text]?.enabled === false) {\r\n    previewUnit.style.display = 'none';\r\n    return previewUnit;\r\n  }\r\n\r\n  const elementPosition = wordElement.getBoundingClientRect().top;\r\n\r\n  previewUnit.style.position = 'absolute';\r\n  previewUnit.style.top = `${(elementPosition / docHeight) * 100}%`;\r\n  previewUnit.style.width = '100%';\r\n  previewUnit.style.height = '1px';\r\n  previewUnit.style.border = `1px solid ${word.previewBorderColor}`;\r\n  previewUnit.style.backgroundColor = word.color;\r\n  return previewUnit;\r\n};\r\n\r\nexport const buildQuickviewPreviewBar = (\r\n  words: Record<string, QuickviewWordHighlight>,\r\n  highlightKeywords: HighlightKeywords,\r\n  iframe?: HTMLIFrameElement\r\n) => {\r\n  if (!iframe) {\r\n    return;\r\n  }\r\n  const documentWriter = iframe.contentDocument;\r\n  if (!documentWriter) {\r\n    return;\r\n  }\r\n  const bar = buildPreviewBar(documentWriter);\r\n  if (highlightKeywords.highlightNone) {\r\n    bar.remove();\r\n    return;\r\n  }\r\n  const docHeight = documentWriter.body.scrollHeight;\r\n\r\n  Object.values(words).forEach((word) => {\r\n    word.elements.forEach((wordElement) => {\r\n      const previewUnit = buildPreviewUnit(\r\n        documentWriter,\r\n        word,\r\n        wordElement,\r\n        docHeight,\r\n        highlightKeywords\r\n      );\r\n\r\n      bar.appendChild(previewUnit);\r\n    });\r\n  });\r\n  documentWriter.body.appendChild(bar);\r\n};\r\n","export const rgbToHsv = (r: number, g: number, b: number) => {\r\n  const max = Math.max(r, g, b);\r\n  const min = Math.min(r, g, b);\r\n\r\n  let h: number;\r\n  const v = max;\r\n\r\n  const d = max - min;\r\n  const s = max === 0 ? 0 : d / max;\r\n\r\n  if (max === min) {\r\n    h = 0;\r\n  } else {\r\n    switch (max) {\r\n      case r:\r\n        h = (g - b) / d + (g < b ? 6 : 0);\r\n        break;\r\n      case g:\r\n        h = (b - r) / d + 2;\r\n        break;\r\n      case b:\r\n      default:\r\n        h = (r - g) / d + 4;\r\n        break;\r\n    }\r\n    h /= 6;\r\n  }\r\n\r\n  return {h, s, v};\r\n};\r\n\r\nexport const hsvToRgb = (h: number, s: number, v: number) => {\r\n  let r, g, b;\r\n\r\n  const i = Math.floor(h * 6);\r\n  const f = h * 6 - i;\r\n  const p = v * (1 - s);\r\n  const q = v * (1 - f * s);\r\n  const t = v * (1 - (1 - f) * s);\r\n\r\n  switch (i % 6) {\r\n    case 0:\r\n      (r = v), (g = t), (b = p);\r\n      break;\r\n    case 1:\r\n      (r = q), (g = v), (b = p);\r\n      break;\r\n    case 2:\r\n      (r = p), (g = v), (b = t);\r\n      break;\r\n    case 3:\r\n      (r = p), (g = q), (b = v);\r\n      break;\r\n    case 4:\r\n      (r = t), (g = p), (b = v);\r\n      break;\r\n    case 5:\r\n    default:\r\n      (r = v), (g = p), (b = q);\r\n      break;\r\n  }\r\n\r\n  return {\r\n    r: Math.round(r),\r\n    g: Math.round(g),\r\n    b: Math.round(b),\r\n  };\r\n};\r\n","import {TermsToHighlight} from '@coveo/headless';\r\nimport {hsvToRgb, rgbToHsv} from '../../../../utils/color-utils';\r\n\r\nexport const HIGHLIGHT_PREFIX = 'CoveoHighlight';\r\nexport class QuickviewWordHighlight {\r\n  public text: string;\r\n  public indexIdentifier: string;\r\n  public occurrences = 0;\r\n  public color: string;\r\n  public focusedColor: string;\r\n  public previewBorderColor: string;\r\n  public elements: HTMLElement[] = [];\r\n\r\n  private currentNavigationPosition = -1;\r\n\r\n  constructor(\r\n    private stemmingInfoFromIndex: TermsToHighlight,\r\n    keywordElementInIframe: HTMLElement\r\n  ) {\r\n    const parsed = this.parseKeywordIdentifier(keywordElementInIframe);\r\n    if (!parsed) {\r\n      throw 'Invalid keyword identifier for quickview';\r\n    }\r\n\r\n    this.text = this.getText(keywordElementInIframe);\r\n    this.indexIdentifier = `${parsed.keywordIdentifier}-${this.text}`;\r\n    this.color = keywordElementInIframe.style.backgroundColor;\r\n    this.focusedColor = this.computeInvertedColor();\r\n    this.previewBorderColor = this.computeSaturatedColor();\r\n\r\n    this.addElement(keywordElementInIframe);\r\n  }\r\n\r\n  public addElement(keywordElementInIframe: HTMLElement) {\r\n    this.occurrences++;\r\n    this.elements.push(keywordElementInIframe);\r\n  }\r\n\r\n  public navigateForward() {\r\n    this.currentNavigationPosition++;\r\n    if (this.currentNavigationPosition >= this.elements.length) {\r\n      this.currentNavigationPosition = 0;\r\n    }\r\n    this.highlightNavigation();\r\n    this.putElementIntoView();\r\n    return this.elements[this.currentNavigationPosition];\r\n  }\r\n\r\n  public navigateBackward() {\r\n    this.currentNavigationPosition--;\r\n    if (this.currentNavigationPosition < 0) {\r\n      this.currentNavigationPosition = this.elements.length - 1;\r\n    }\r\n    this.highlightNavigation();\r\n    this.putElementIntoView();\r\n    return this.elements[this.currentNavigationPosition];\r\n  }\r\n\r\n  private isTaggedWord(element: HTMLElement) {\r\n    return element.nodeName.toLowerCase() === 'coveotaggedword';\r\n  }\r\n\r\n  private highlightNavigation() {\r\n    const currentElement = this.elements[this.currentNavigationPosition];\r\n    const otherElements = this.elements.filter((el) => el !== currentElement);\r\n    currentElement.style.color = this.color;\r\n    currentElement.style.backgroundColor = this.focusedColor;\r\n    otherElements.forEach((element) => {\r\n      element.style.color = '';\r\n      element.style.backgroundColor = this.color;\r\n    });\r\n  }\r\n\r\n  private putElementIntoView() {\r\n    const element = this.elements[this.currentNavigationPosition];\r\n    element.scrollIntoView();\r\n  }\r\n\r\n  private getText(element: HTMLElement) {\r\n    const innerTextOfHTMLElement = this.getHighlightedInnerText(element);\r\n    return this.resolveOriginalTerm(innerTextOfHTMLElement).trim();\r\n  }\r\n\r\n  private resolveOriginalTerm(highlight: string): string {\r\n    // First try to find either an exact match between the highlight and the original non-stemmed keyword.\r\n    // Otherwise try to find a match between the highlight and the stemming keyword expansions\r\n    // If nothing is found (which should not normally happen...), simply return the highlight keyword as is.\r\n\r\n    const found = Object.keys(this.stemmingInfoFromIndex).find(\r\n      (originalTerm) => {\r\n        const originalTermMatch =\r\n          originalTerm.toLowerCase() === highlight.toLowerCase();\r\n        if (originalTermMatch) {\r\n          return true;\r\n        }\r\n        const stemmingExpansions = this.stemmingInfoFromIndex[originalTerm];\r\n        if (!stemmingExpansions) {\r\n          return false;\r\n        }\r\n\r\n        const stemmingExpansionMatch = stemmingExpansions.find(\r\n          (stemmingExpansion) =>\r\n            stemmingExpansion.toLowerCase() === highlight.toLowerCase()\r\n        );\r\n        return stemmingExpansionMatch;\r\n      }\r\n    );\r\n    return found || highlight;\r\n  }\r\n\r\n  private getHighlightedInnerText(element: HTMLElement): string {\r\n    if (!this.isTaggedWord(element)) {\r\n      return this.getTextOfHTMLElement(element);\r\n    }\r\n\r\n    const children = Array.from(element.children) as HTMLElement[];\r\n    if (children.length >= 1) {\r\n      return this.getTextOfHTMLElement(children[0]);\r\n    }\r\n\r\n    return '';\r\n  }\r\n\r\n  private parseKeywordIdentifier(element: HTMLElement) {\r\n    const parts = element.id\r\n      .substring(HIGHLIGHT_PREFIX.length + 1)\r\n      .match(/^([0-9]+)\\.([0-9]+)\\.([0-9]+)$/);\r\n\r\n    if (!parts || parts.length <= 3) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      keywordIdentifier: parts[1],\r\n      keywordTermPart: parseInt(parts[3], 10),\r\n    };\r\n  }\r\n\r\n  private getTextOfHTMLElement(el: HTMLElement) {\r\n    return el.innerText || el.textContent || '';\r\n  }\r\n\r\n  private computeInvertedColor() {\r\n    const {r, g, b} = this.extractRgb();\r\n    return `rgb(${255 - r}, ${255 - g}, ${255 - b})`;\r\n  }\r\n\r\n  private computeSaturatedColor() {\r\n    const {r, g, b} = this.extractRgb();\r\n    const {h, s, v} = rgbToHsv(r, g, b);\r\n    let newSaturation = s * 2;\r\n    if (newSaturation > 1) {\r\n      newSaturation = 1;\r\n    }\r\n    const {\r\n      r: rSaturated,\r\n      g: gSaturated,\r\n      b: bSaturated,\r\n    } = hsvToRgb(h, newSaturation, v);\r\n    return `rgb(${rSaturated}, ${gSaturated}, ${bSaturated})`;\r\n  }\r\n\r\n  private extractRgb() {\r\n    const rgbExtracted = this.color.match(/\\d+/g);\r\n    if (!rgbExtracted) {\r\n      return {r: 255, g: 255, b: 255};\r\n    }\r\n\r\n    return {\r\n      r: parseInt(rgbExtracted[0], 10),\r\n      g: parseInt(rgbExtracted[1], 10),\r\n      b: parseInt(rgbExtracted[2], 10),\r\n    };\r\n  }\r\n}\r\n\r\nexport const getWordsHighlights = (\r\n  stemmingInfoFromIndex: TermsToHighlight,\r\n  iframe?: HTMLIFrameElement\r\n) => {\r\n  const wordsHighlights: Record<string, QuickviewWordHighlight> = {};\r\n  if (!iframe) {\r\n    return wordsHighlights;\r\n  }\r\n\r\n  iframe.contentDocument?.body\r\n    .querySelectorAll(`[id^=\"${HIGHLIGHT_PREFIX}\"]`)\r\n    .forEach((el) => {\r\n      const wordHTMLElementToHighlight = el as HTMLElement;\r\n\r\n      const wordHighlight = new QuickviewWordHighlight(\r\n        stemmingInfoFromIndex,\r\n        wordHTMLElementToHighlight\r\n      );\r\n\r\n      if (!wordHighlight.text) {\r\n        return;\r\n      }\r\n\r\n      const alreadyScannedKeyword =\r\n        wordsHighlights[wordHighlight.indexIdentifier];\r\n\r\n      if (alreadyScannedKeyword) {\r\n        alreadyScannedKeyword.addElement(wordHTMLElementToHighlight);\r\n      } else {\r\n        wordsHighlights[wordHighlight.indexIdentifier] = wordHighlight;\r\n      }\r\n    });\r\n\r\n  return wordsHighlights;\r\n};\r\n","@import '../../../../global/global.pcss';\r\n@import '../../../../global/mixins.pcss';\r\n\r\n.atomic-quickview-modal {\r\n  &::part(backdrop) {\r\n    grid-template-columns: 1fr max(80vw, 30rem) 1fr;\r\n  }\r\n  &::part(body),\r\n  &::part(header),\r\n  &::part(footer) {\r\n    @apply max-w-full;\r\n  }\r\n\r\n  &::part(footer) {\r\n    @apply flex justify-center;\r\n  }\r\n\r\n  &::part(body-wrapper) {\r\n    @apply p-0 overflow-hidden h-full;\r\n  }\r\n\r\n  &::part(body) {\r\n    @apply h-full;\r\n  }\r\n\r\n  &::part(backdrop) {\r\n    grid-template-rows: 1fr 100% 3fr;\r\n  }\r\n\r\n  &::part(header-wrapper) {\r\n    @apply bg-neutral-light;\r\n  }\r\n\r\n  a {\r\n    @mixin link-style;\r\n  }\r\n}\r\n","import {\r\n  buildInteractiveResult,\r\n  Result,\r\n  InteractiveResult,\r\n  TermsToHighlight,\r\n} from '@coveo/headless';\r\nimport {\r\n  Component,\r\n  Event,\r\n  EventEmitter,\r\n  h,\r\n  Prop,\r\n  State,\r\n  Watch,\r\n  Method,\r\n  VNode,\r\n  Fragment,\r\n} from '@stencil/core';\r\nimport CloseIcon from '../../../../images/close.svg';\r\nimport {\r\n  InitializableComponent,\r\n  InitializeBindings,\r\n} from '../../../../utils/initialization-utils';\r\nimport {Button} from '../../../common/button';\r\nimport {IconButton} from '../../../common/iconButton';\r\nimport {LinkWithItemAnalytics} from '../../../common/item-link/item-link';\r\nimport {Bindings} from '../../atomic-search-interface/atomic-search-interface';\r\nimport {QuickviewSidebar} from '../atomic-quickview-sidebar/atomic-quickview-sidebar';\r\nimport {QuickviewIframe} from '../quickview-iframe/quickview-iframe';\r\nimport {buildQuickviewPreviewBar} from '../quickview-preview-bar/quickview-preview-bar';\r\nimport {\r\n  getWordsHighlights,\r\n  HIGHLIGHT_PREFIX,\r\n  QuickviewWordHighlight,\r\n} from '../quickview-word-highlight/quickview-word-highlight';\r\n\r\nexport interface HighlightKeywords {\r\n  highlightNone: boolean;\r\n  keywords: {\r\n    [text: string]: {\r\n      indexIdentifier: string;\r\n      enabled: boolean;\r\n    };\r\n  };\r\n}\r\n\r\n/**\r\n * The modal opened when clicking on a quickview button.\r\n * Do not use this component directly; use `atomic-quickview` instead.\r\n *\r\n * @part quickview-modal-header-icon - The close icon of the modal.\r\n * @part quickview-modal-header-title - The title of the modal.\r\n */\r\n@Component({\r\n  tag: 'atomic-quickview-modal',\r\n  styleUrl: 'atomic-quickview-modal.pcss',\r\n  shadow: true,\r\n})\r\nexport class AtomicQuickviewModal implements InitializableComponent {\r\n  @InitializeBindings() public bindings!: Bindings;\r\n  @State() public error!: Error;\r\n\r\n  @State() private highlightKeywords: HighlightKeywords = {\r\n    highlightNone: false,\r\n    keywords: {},\r\n  };\r\n  @Watch('highlightKeywords')\r\n  watchHighlightKeywords() {\r\n    this.handleHighlightsScripts();\r\n  }\r\n\r\n  @Event({eventName: 'atomic/quickview/next'}) nextQuickview?: EventEmitter;\r\n  @Event({eventName: 'atomic/quickview/previous'})\r\n  previousQuickview?: EventEmitter;\r\n\r\n  @State() private minimizeSidebar = false;\r\n  @State() private words: Record<string, QuickviewWordHighlight> = {};\r\n  private iframeRef?: HTMLIFrameElement;\r\n\r\n  @Prop({mutable: true, reflect: false}) content?: string;\r\n  @Prop({mutable: true, reflect: false}) result?: Result;\r\n  @Prop() current?: number;\r\n  @Prop() total?: number;\r\n  @Prop() sandbox?: string;\r\n  @Prop() modalCloseCallback?: () => void;\r\n\r\n  private interactiveResult?: InteractiveResult;\r\n\r\n  public componentWillRender(): void {\r\n    this.minimizeSidebar = this.bindings.store.isMobile();\r\n  }\r\n\r\n  @Method()\r\n  public async reset() {\r\n    this.highlightKeywords = {\r\n      highlightNone: false,\r\n      keywords: {},\r\n    };\r\n    this.minimizeSidebar = false;\r\n    this.iframeRef = undefined;\r\n    this.content = undefined;\r\n    this.result = undefined;\r\n    this.interactiveResult = undefined;\r\n  }\r\n\r\n  private renderHeader() {\r\n    let headerContent: VNode | null = null;\r\n    if (this.result) {\r\n      this.interactiveResult = buildInteractiveResult(this.bindings.engine, {\r\n        options: {result: this.result},\r\n      });\r\n      headerContent = (\r\n        <Fragment>\r\n          <LinkWithItemAnalytics\r\n            href={this.result?.clickUri}\r\n            onSelect={() => this.interactiveResult?.select()}\r\n            onBeginDelayedSelect={() =>\r\n              this.interactiveResult?.beginDelayedSelect()\r\n            }\r\n            onCancelPendingSelect={() =>\r\n              this.interactiveResult?.cancelPendingSelect()\r\n            }\r\n            className=\"truncate\"\r\n            part=\"quickview-modal-header-title\"\r\n          >\r\n            {this.result.title}\r\n          </LinkWithItemAnalytics>\r\n          <IconButton\r\n            partPrefix=\"quickview-modal-header\"\r\n            icon={CloseIcon}\r\n            onClick={() => this.onClose()}\r\n            ariaLabel={this.bindings.i18n.t('close')}\r\n            style=\"text-transparent\"\r\n            title={this.bindings.i18n.t('close')}\r\n          />\r\n        </Fragment>\r\n      );\r\n    }\r\n    return (\r\n      <div slot=\"header\" class=\"w-full flex justify-between items-center\">\r\n        {headerContent}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderBody() {\r\n    return (\r\n      <div slot=\"body\" class=\"grid grid-cols-[min-content_auto] h-full\">\r\n        <div\r\n          class=\"h-full overflow-y-auto\"\r\n          style={{backgroundColor: 'var(--atomic-neutral-light)'}}\r\n        >\r\n          <QuickviewSidebar\r\n            words={this.words}\r\n            i18n={this.bindings.i18n}\r\n            highlightKeywords={this.highlightKeywords}\r\n            onHighlightKeywords={(highlight) =>\r\n              (this.highlightKeywords = highlight)\r\n            }\r\n            minimized={this.minimizeSidebar}\r\n            onMinimize={(minimize) => (this.minimizeSidebar = minimize)}\r\n          />\r\n        </div>\r\n        <div class=\"overflow-auto relative\">\r\n          <QuickviewIframe\r\n            logger={this.logger}\r\n            src={this.quickviewSrc}\r\n            sandbox={this.sandbox}\r\n            uniqueIdentifier={this.quickviewUniqueIdentifier}\r\n            content={this.content}\r\n            onSetIframeRef={async (ref) => {\r\n              this.iframeRef = ref;\r\n              this.words = getWordsHighlights(\r\n                this.termsToHighlight,\r\n                this.iframeRef\r\n              );\r\n              this.handleHighlightsScripts();\r\n            }}\r\n          />\r\n          {buildQuickviewPreviewBar(\r\n            this.words,\r\n            this.highlightKeywords,\r\n            this.iframeRef\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderFooter() {\r\n    return (\r\n      <div slot=\"footer\" class=\"flex items-center gap-2\">\r\n        <Button\r\n          class=\"p-2\"\r\n          style=\"square-neutral\"\r\n          onClick={() => this.previousQuickview?.emit()}\r\n          text={this.bindings.i18n.t('quickview-previous')}\r\n        ></Button>\r\n        <p class=\"text-center\">\r\n          {this.bindings.i18n.t('showing-results-of', {\r\n            first: this.current,\r\n            total: this.total,\r\n          })}\r\n        </p>\r\n        <Button\r\n          class=\"p-2\"\r\n          style=\"square-neutral\"\r\n          onClick={() => this.nextQuickview?.emit()}\r\n          text={this.bindings.i18n.t('quickview-next')}\r\n        ></Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private onClose() {\r\n    this.content = undefined;\r\n    this.result = undefined;\r\n    this.modalCloseCallback && this.modalCloseCallback();\r\n  }\r\n\r\n  private get isOpen() {\r\n    return !!this.content && !!this.result;\r\n  }\r\n\r\n  private get highlightScriptId() {\r\n    return 'CoveoDisableHighlightStyle';\r\n  }\r\n\r\n  private get logger() {\r\n    return this.bindings.engine.logger;\r\n  }\r\n\r\n  private get quickviewSrc() {\r\n    return this.bindings.engine.state.resultPreview?.contentURL;\r\n  }\r\n\r\n  private enableHighlights() {\r\n    this.removeDisableHighlightScript();\r\n  }\r\n\r\n  private enableHighlightsSpecificKeyword(identifier: string) {\r\n    this.removeDisableHighlightScript(identifier);\r\n  }\r\n\r\n  private disableHighlights() {\r\n    this.createDisableHighlightScript();\r\n  }\r\n\r\n  private disableHighlightsSpecificKeyword(identifier: string) {\r\n    this.createDisableHighlightScript(identifier);\r\n  }\r\n\r\n  private removeDisableHighlightScript(identifier?: string) {\r\n    const doc = this.iframeRef?.contentWindow?.document;\r\n    if (!doc) {\r\n      return;\r\n    }\r\n    doc\r\n      .getElementById(\r\n        `${this.highlightScriptId}${identifier ? `:${identifier}` : ''}`\r\n      )\r\n      ?.remove();\r\n  }\r\n\r\n  private createDisableHighlightScript(identifier?: string) {\r\n    const doc = this.iframeRef?.contentWindow?.document;\r\n    if (!doc) {\r\n      return;\r\n    }\r\n\r\n    const head = doc.head;\r\n    const scriptId = `${this.highlightScriptId}${\r\n      identifier ? `:${identifier}` : ''\r\n    }`;\r\n    const style =\r\n      doc.getElementById(scriptId) || this.bindings.createStyleElement();\r\n    style.setAttribute('id', scriptId);\r\n    head.appendChild(style);\r\n    style.appendChild(\r\n      doc.createTextNode(`[id^=\"${HIGHLIGHT_PREFIX}${\r\n        identifier ? `:${identifier}` : ''\r\n      }\"] {\r\n      background-color: inherit !important;\r\n      color: inherit !important;\r\n    }`)\r\n    );\r\n  }\r\n\r\n  private get termsToHighlight() {\r\n    const flatPhrasesToHighlight: TermsToHighlight = {};\r\n\r\n    const phrasesToHighlight =\r\n      this.bindings.engine.state.search.response.phrasesToHighlight;\r\n\r\n    Object.entries(phrasesToHighlight).forEach(([phrase, keywords]) => {\r\n      flatPhrasesToHighlight[phrase] = Object.entries(keywords).flatMap(\r\n        ([keywordEntry, keywordStemming]) => {\r\n          return [keywordEntry, ...keywordStemming];\r\n        }\r\n      );\r\n    });\r\n\r\n    return {\r\n      ...this.bindings.engine.state.search.response.termsToHighlight,\r\n      ...flatPhrasesToHighlight,\r\n    };\r\n  }\r\n\r\n  private get requestId() {\r\n    return this.bindings.engine.state.search.requestId;\r\n  }\r\n\r\n  private get quickviewUniqueIdentifier() {\r\n    return this.result?.uniqueId + this.requestId;\r\n  }\r\n\r\n  private handleHighlightsScripts() {\r\n    if (!this.highlightKeywords.highlightNone) {\r\n      this.enableHighlights();\r\n    } else {\r\n      this.disableHighlights();\r\n    }\r\n    Object.values(this.highlightKeywords.keywords).forEach((word) => {\r\n      if (word.enabled) {\r\n        this.enableHighlightsSpecificKeyword(word.indexIdentifier);\r\n      } else {\r\n        this.disableHighlightsSpecificKeyword(word.indexIdentifier);\r\n      }\r\n    });\r\n  }\r\n\r\n  public render() {\r\n    return (\r\n      <atomic-modal\r\n        fullscreen={this.bindings.store.isMobile()}\r\n        class={'atomic-quickview-modal'}\r\n        isOpen={this.isOpen}\r\n        close={() => this.onClose()}\r\n      >\r\n        {this.renderHeader()}\r\n        {this.renderBody()}\r\n        {this.renderFooter()}\r\n      </atomic-modal>\r\n    );\r\n  }\r\n}\r\n"],"mappings":"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"}