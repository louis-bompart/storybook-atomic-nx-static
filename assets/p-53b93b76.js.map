{"version":3,"names":["findAriaLiveEventName","AriaLiveRegion","regionName","assertive","getAriaLiveElement","event","buildCustomEvent","document","dispatchEvent","element","detail","dispatchMessage","message","_a","updateMessage","registerRegion","component","setterName","componentWillRender","Object","defineProperty","set","call","this","FocusTargetController","constructor","doFocusAfterSearch","doFocusOnNextTarget","bindings","handleComponentRenderLoop","setTarget","el","focus","defer","_b","onFocusCallback","focusAfterSearch","lastSearchId","store","getUniqueIDFromEngine","engine","Promise","resolve","focusOnNextTarget","disableForCurrentSearch","originalComponentDidRender","componentDidRender","then","isFocusable","getAttribute","hasAttribute","tagName","getFocusableDescendants","children","Array","from","HTMLSlotElement","assignedElements","shadowRoot","push","child","getFirstFocusableDescendant","next","value"],"sources":["src/utils/accessibility-utils.tsx"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport {AnyBindings} from '../components/common/interface/bindings';\r\nimport {buildCustomEvent} from './event-utils';\r\nimport {InitializableComponent} from './initialization-utils';\r\nimport {defer} from './utils';\r\n\r\nexport const findAriaLiveEventName = 'atomic/accessibility/findAriaLive';\r\n\r\nexport interface FindAriaLiveEventArgs {\r\n  element?: HTMLAtomicAriaLiveElement;\r\n}\r\n\r\nexport function AriaLiveRegion(regionName: string, assertive = false) {\r\n  function getAriaLiveElement() {\r\n    const event = buildCustomEvent<FindAriaLiveEventArgs>(\r\n      findAriaLiveEventName,\r\n      {}\r\n    );\r\n    document.dispatchEvent(event);\r\n    const {element} = event.detail;\r\n    return element;\r\n  }\r\n\r\n  function dispatchMessage(message: string) {\r\n    getAriaLiveElement()?.updateMessage(regionName, message, assertive);\r\n  }\r\n\r\n  function registerRegion() {\r\n    getAriaLiveElement()?.registerRegion(regionName, assertive);\r\n  }\r\n\r\n  return (\r\n    component: InitializableComponent<AnyBindings>,\r\n    setterName: string\r\n  ) => {\r\n    const {componentWillRender} = component;\r\n    Object.defineProperty(component, setterName, {\r\n      set: (message: string) => dispatchMessage(message),\r\n    });\r\n\r\n    component.componentWillRender = function () {\r\n      componentWillRender && componentWillRender.call(this);\r\n      registerRegion();\r\n    };\r\n  };\r\n}\r\n\r\nexport class FocusTargetController {\r\n  private bindings: AnyBindings;\r\n  private lastSearchId?: string;\r\n  private element?: HTMLElement;\r\n  private onFocusCallback?: Function;\r\n  private doFocusAfterSearch = false;\r\n  private doFocusOnNextTarget = false;\r\n\r\n  constructor(private component: InitializableComponent<AnyBindings>) {\r\n    this.bindings = component.bindings;\r\n    this.handleComponentRenderLoop();\r\n  }\r\n\r\n  public setTarget(el: HTMLElement | undefined) {\r\n    if (!el) {\r\n      return;\r\n    }\r\n    this.element = el;\r\n    if (this.doFocusOnNextTarget) {\r\n      this.doFocusOnNextTarget = false;\r\n      this.focus();\r\n    }\r\n  }\r\n\r\n  public async focus() {\r\n    await defer();\r\n    this.element?.focus();\r\n    this.onFocusCallback?.();\r\n  }\r\n\r\n  public focusAfterSearch() {\r\n    this.lastSearchId = this.bindings.store.getUniqueIDFromEngine(\r\n      this.bindings.engine\r\n    );\r\n    this.doFocusAfterSearch = true;\r\n    return new Promise((resolve) => (this.onFocusCallback = resolve));\r\n  }\r\n\r\n  public focusOnNextTarget() {\r\n    this.doFocusOnNextTarget = true;\r\n    return new Promise((resolve) => (this.onFocusCallback = resolve));\r\n  }\r\n\r\n  public disableForCurrentSearch() {\r\n    if (\r\n      this.bindings.store.getUniqueIDFromEngine(this.bindings.engine) !==\r\n      this.lastSearchId\r\n    ) {\r\n      this.doFocusAfterSearch = false;\r\n    }\r\n  }\r\n\r\n  private handleComponentRenderLoop() {\r\n    const originalComponentDidRender = this.component.componentDidRender;\r\n\r\n    this.component.componentDidRender = () => {\r\n      originalComponentDidRender &&\r\n        originalComponentDidRender.call(this.component);\r\n      if (!this.bindings) {\r\n        return;\r\n      }\r\n      if (\r\n        this.doFocusAfterSearch &&\r\n        this.bindings.store.getUniqueIDFromEngine(this.bindings.engine) !==\r\n          this.lastSearchId\r\n      ) {\r\n        this.doFocusAfterSearch = false;\r\n        if (this.element) {\r\n          const el = this.element;\r\n          // The focus seems to be flaky without deferring, especially on iOS.\r\n          defer().then(() => {\r\n            el.focus();\r\n            this.onFocusCallback?.();\r\n          });\r\n        }\r\n      }\r\n    };\r\n  }\r\n}\r\n\r\nfunction isFocusable(element: Element) {\r\n  // Source: https://stackoverflow.com/a/30753870\r\n  if (element.getAttribute('tabindex') === '-1') {\r\n    return false;\r\n  }\r\n  if (element.hasAttribute('tabindex')) {\r\n    return true;\r\n  }\r\n  if (element.getAttribute('contentEditable') === 'true') {\r\n    return true;\r\n  }\r\n  switch (element.tagName) {\r\n    case 'A':\r\n    case 'AREA':\r\n      return element.hasAttribute('href');\r\n    case 'INPUT':\r\n    case 'SELECT':\r\n    case 'TEXTAREA':\r\n    case 'BUTTON':\r\n      return !element.hasAttribute('disabled');\r\n    case 'IFRAME':\r\n      return true;\r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\nexport function* getFocusableDescendants(\r\n  element: Element\r\n): Generator<HTMLElement> {\r\n  if (isFocusable(element)) {\r\n    yield element as HTMLElement;\r\n  }\r\n  let children = Array.from(element.children);\r\n  if (element instanceof HTMLSlotElement) {\r\n    children = element.assignedElements();\r\n  } else if (element.shadowRoot) {\r\n    children.push(...Array.from(element.shadowRoot.children));\r\n  }\r\n  for (const child of children) {\r\n    yield* getFocusableDescendants(child);\r\n  }\r\n}\r\n\r\nexport function getFirstFocusableDescendant(\r\n  element: Element\r\n): HTMLElement | null {\r\n  return getFocusableDescendants(element).next().value ?? null;\r\n}\r\n"],"mappings":"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"}