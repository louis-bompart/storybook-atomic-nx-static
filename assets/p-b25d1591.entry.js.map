{"version":3,"names":["AtomicFacetManager","this","collapseFacetsAfter","sortFacets","facets","getFacetsInChildren","host","sortedFacets","sortFacetsUsingManager","facetManager","visibleFacets","invisibleFacets","sortFacetVisibility","bindings","store","getAllFacets","generator","getAutomaticFacetGenerator","updateCollapseFacetsDependingOnFacetsVisibility","length","append","initialize","validateProps","buildFacetManager","engine","i18n","on","Schema","collapseFacetAfter","NumberValue","min","required","validate","payload","map","f","facetId","sort","disconnectedCallback","off","render","h","key","__decorate","InitializeBindings","BindStateToController","onUpdateCallbackMethod"],"sources":["src/components/search/atomic-facet-manager/atomic-facet-manager.tsx"],"sourcesContent":["import {NumberValue, Schema} from '@coveo/bueno';\r\nimport {\r\n  FacetManager,\r\n  buildFacetManager,\r\n  FacetManagerState,\r\n} from '@coveo/headless';\r\nimport {Component, h, Element, State, Prop} from '@stencil/core';\r\nimport {\r\n  BindStateToController,\r\n  InitializableComponent,\r\n  InitializeBindings,\r\n} from '../../../utils/initialization-utils';\r\nimport {\r\n  getFacetsInChildren,\r\n  getAutomaticFacetGenerator,\r\n  sortFacetVisibility,\r\n  collapseFacetsAfter,\r\n  BaseFacetElement,\r\n} from '../../common/facets/facet-common';\r\nimport {Bindings} from '../atomic-search-interface/atomic-search-interface';\r\n\r\n/**\r\n * The `atomic-facet-manager` helps reorder facets and their values to match the most recent search response with the most relevant results.\r\n * @slot default - Facet components are slotted within to leverage this functionality.\r\n */\r\n@Component({\r\n  tag: 'atomic-facet-manager',\r\n  shadow: false,\r\n})\r\nexport class AtomicFacetManager implements InitializableComponent {\r\n  @InitializeBindings() public bindings!: Bindings;\r\n  private facetManager!: FacetManager;\r\n\r\n  @Element() private host!: HTMLDivElement;\r\n\r\n  @BindStateToController('facetManager', {\r\n    onUpdateCallbackMethod: 'sortFacets',\r\n  })\r\n  @State()\r\n  public facetManagerState!: FacetManagerState;\r\n  @State() public error!: Error;\r\n\r\n  /**\r\n   * The number of expanded facets inside the manager.\r\n   * Remaining facets are automatically collapsed.\r\n   *\r\n   * Using the value `0` collapses all facets.\r\n   * Using the value `-1` disables the feature and keeps all facets expanded. Useful when you want to set the collapse state for each facet individually.\r\n   */\r\n  @Prop({reflect: true}) public collapseFacetsAfter = 4;\r\n\r\n  public initialize() {\r\n    this.validateProps();\r\n    this.facetManager = buildFacetManager(this.bindings.engine);\r\n\r\n    // An update has to be forced for the facets to be visually updated, without being interacted with.\r\n    this.bindings.i18n.on('languageChanged', this.sortFacets);\r\n  }\r\n\r\n  private sortFacets = () => {\r\n    const facets = getFacetsInChildren(this.host);\r\n\r\n    const sortedFacets = this.sortFacetsUsingManager(facets, this.facetManager);\r\n\r\n    const {visibleFacets, invisibleFacets} = sortFacetVisibility(\r\n      sortedFacets,\r\n      this.bindings.store.getAllFacets()\r\n    );\r\n\r\n    const generator = getAutomaticFacetGenerator(this.host);\r\n\r\n    collapseFacetsAfter(visibleFacets, this.collapseFacetsAfter);\r\n\r\n    generator?.updateCollapseFacetsDependingOnFacetsVisibility(\r\n      this.collapseFacetsAfter,\r\n      visibleFacets.length\r\n    );\r\n\r\n    this.host.append(\r\n      ...[\r\n        ...visibleFacets,\r\n        ...invisibleFacets,\r\n        ...(generator ? [generator] : []),\r\n      ]\r\n    );\r\n  };\r\n\r\n  private validateProps() {\r\n    new Schema({\r\n      collapseFacetAfter: new NumberValue({min: -1, required: true}),\r\n    }).validate({\r\n      collapseFacetAfter: this.collapseFacetsAfter,\r\n    });\r\n  }\r\n\r\n  private sortFacetsUsingManager(\r\n    facets: BaseFacetElement[],\r\n    facetManager: FacetManager\r\n  ): BaseFacetElement[] {\r\n    const payload = facets.map((f) => ({\r\n      facetId: f.facetId,\r\n      payload: f,\r\n    }));\r\n    return facetManager.sort(payload).map((f) => f.payload);\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    this.bindings.i18n.off('languageChanged', this.sortFacets);\r\n  }\r\n\r\n  public render() {\r\n    return <slot />;\r\n  }\r\n}\r\n"],"mappings":"8pBA6BaA,EAAkB,M,yBAoBCC,KAAAC,oBAAsB,EAU5CD,KAAAE,WAAa,KACnB,MAAMC,EAASC,EAAoBJ,KAAKK,MAExC,MAAMC,EAAeN,KAAKO,uBAAuBJ,EAAQH,KAAKQ,cAE9D,MAAMC,cAACA,EAAaC,gBAAEA,GAAmBC,EACvCL,EACAN,KAAKY,SAASC,MAAMC,gBAGtB,MAAMC,EAAYC,EAA2BhB,KAAKK,MAElDJ,EAAoBQ,EAAeT,KAAKC,qBAExCc,IAAS,MAATA,SAAS,SAATA,EAAWE,gDACTjB,KAAKC,oBACLQ,EAAcS,QAGhBlB,KAAKK,KAAKc,UACL,IACEV,KACAC,KACCK,EAAY,CAACA,GAAa,IAEjC,E,+EAnCiD,C,CAE7C,UAAAK,GACLpB,KAAKqB,gBACLrB,KAAKQ,aAAec,EAAkBtB,KAAKY,SAASW,QAGpDvB,KAAKY,SAASY,KAAKC,GAAG,kBAAmBzB,KAAKE,W,CA+BxC,aAAAmB,GACN,IAAIK,EAAO,CACTC,mBAAoB,IAAIC,EAAY,CAACC,KAAM,EAAGC,SAAU,SACvDC,SAAS,CACVJ,mBAAoB3B,KAAKC,qB,CAIrB,sBAAAM,CACNJ,EACAK,GAEA,MAAMwB,EAAU7B,EAAO8B,KAAKC,IAAC,CAC3BC,QAASD,EAAEC,QACXH,QAASE,MAEX,OAAO1B,EAAa4B,KAAKJ,GAASC,KAAKC,GAAMA,EAAEF,S,CAGjD,oBAAAK,GACErC,KAAKY,SAASY,KAAKc,IAAI,kBAAmBtC,KAAKE,W,CAG1C,MAAAqC,GACL,OAAOC,EAAA,QAAAC,IAAA,4C,6BAjFoBC,EAAA,CAA5BC,K,+BASMD,EAAA,CAJNE,EAAsB,eAAgB,CACrCC,uBAAwB,gB"}